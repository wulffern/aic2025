# Sample workflow for building and deploying a Jekyll site to GitHub Pages
name: matrix

on:
  # Runs on pushes targeting the default branch
  #push:
    #branches: ["main"]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  # Build job
  #
  #
  prepare:
    runs-on: ubuntu-latest
    #container:
    #  image: wulffern/aic:2025_latest
    #  options: --user root
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive
      - name: Install
        run: |
          apt-get update
          apt-get -y install ghostscript pip poppler-utils wget \
          imagemagick python3-svglib python3-venv
          python -m venv /pyenv && /pyenv/bin/python3 -m pip install click \
          svglib numpy pandas matplotlib
          [[ "$(uname -m)" == "x86_65" ]] && wget https://github.com/jgm/pandoc/releases/download/3.7.0.2/pandoc-3.7.0.2-1-amd64.deb &&  sudo dpkg -i pandoc-3.7.0.2-1-amd64.deb
          [[ "$(uname -m)" == "aarch64" ]] && wget https://github.com/jgm/pandoc/releases/download/3.7.0.2/pandoc-3.7.0.2-1-arm64.deb  &&  sudo dpkg -i pandoc-3.7.0.2-1-arm64.deb
      - name: Build posts
        shell: bash
        run: |
          which python3
          git config --global --add safe.directory `pwd`
          make posts texfiles
      - name: Upload shared artifacts
        uses: actions/upload-artifact@v4
        with:
          name: prebuilt
          path: |
            docs/
            pdf/

  build_matrix:
    needs: prepare
    runs-on: ubuntu-latest
    #container:
    #  image: wulffern/aic:2025_latest
    #  options: --user root
    strategy:
      matrix:
        target: [latex, standalone, book]
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive
      - name: Download shared artifacts
        uses: actions/download-artifact@v4
        with:
          name: prebuilt
      - name: Install
        run: |
          apt-get update
          apt-get -y install ghostscript pip poppler-utils pandoc wget \
          imagemagick python3-svglib python3-venv texlive
          python -m venv /pyenv && /pyenv/bin/python3 -m pip install click svglib numpy pandas matplotlib
      - name: Build posts
      - name: Build ${{ matrix.target }}
        shell: bash
        run: |
          git config --global --add safe.directory `pwd`
          make ${{ matrix.target }}
      - name: Upload ${{ matrix.target }} artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.target }}
          path: docs/

  jekyll:
    needs: build_matrix
    runs-on: ubuntu-latest
    #container:
    #    image: wulffern/aic:2025_latest
    #    options: --user root
    steps:
      - name: Download shared artifacts
        uses: actions/download-artifact@v4
        with:
          name: latex
      - name: Download shared artifacts
        uses: actions/download-artifact@v4
        with:
          name: standalone
      - name: Download shared artifacts
        uses: actions/download-artifact@v4
        with:
          name: book
      - name: Setup Pages
        uses: actions/configure-pages@v2
      - name: Build with Jekyll
        uses: actions/jekyll-build-pages@v1
        with:
          source: ./docs/
          destination: ./_site
      - name: Upload artifact
        uses: actions/upload-pages-artifact@main

  # Deployment job
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: jekyll
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@main
